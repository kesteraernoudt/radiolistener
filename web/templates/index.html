<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Audio Monitor</title>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
    }

    textarea {
      width: 100%;
      height: 400px;
      font-family: monospace;
    }

    .logbox {
      width: 100%;
      height: 250px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      background: #000;
      color: #0f0;
      padding: 5px;
      white-space: pre-wrap;
    }

    .tab-buttons {
      display: inline-flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .tab-button {
      border: 1px solid #ccc;
      background: #eee;
      padding: 6px 10px;
      cursor: pointer;
    }

    .tab-button.active {
      background: #ddd;
      border-bottom: 2px solid #000;
      font-weight: bold;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    .section {
      margin-bottom: 30px;
    }

    button {
      margin-top: 5px;
    }

    audio {
      display: block;
      margin-top: 5px;
    }

    .radio-section {
      border: 2px solid #ccc;
      padding: 10px;
      margin-bottom: 30px;
    }

    /* Dashboard Styles */
    .dashboard-container {
      margin-top: 10px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .chart-container h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }

    .averages-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .averages-container h4 {
      margin: 0 0 15px 0;
      font-size: 14px;
      color: #333;
    }

    .averages-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .avg-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      text-align: center;
    }

    .avg-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .avg-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .rate-counter {
      text-align: center;
      padding: 20px;
    }

    .rate-number {
      font-size: 36px;
      font-weight: bold;
      color: #2c5aa0;
    }

    .rate-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    canvas {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>

<body>

  <h1>Audio Monitor</h1>
  <div style="margin-bottom: 20px;">
    <a href="javascript:void(0)" id="filebrowser-link" target="_blank">Open File Browser</a>
  </div>

  <div class="section">
    <h2>Main Config</h2>
    <textarea id="config">{{ config | tojson(indent = 2)}}</textarea><br>
    <button onclick="saveConfig()">Save Config</button>
  </div>

  {% for radio in radios %}
  <div class="radio-section">
    <h2>{{ radio.name }}</h2>
    <div>
      <h3>Live Stream</h3>
      <audio controls>
        <source src="{{ radio.stream_url }}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
      <button onclick="restartRadio('{{ radio.name }}')" style="margin-top:6px;">Restart</button>
    </div>
    <div>
      <h3>Monitoring</h3>
      <div class="tab-buttons">
        <button id="tab-logs-{{ radio.name }}" class="tab-button active" onclick="setActiveTab('{{ radio.name }}','logs')">Logs</button>
        <button id="tab-ai-{{ radio.name }}" class="tab-button" onclick="setActiveTab('{{ radio.name }}','ai')">AI Logs</button>
        <button id="tab-codewords-{{ radio.name }}" class="tab-button" onclick="setActiveTab('{{ radio.name }}','codewords')">Codewords</button>
      </div>
      <div class="tab-pane active" id="logs-pane-{{ radio.name }}">
        <div id="logbox-{{ radio.name }}" class="logbox">{{ radio.logs | join('\n') }}</div>
      </div>
      <div class="tab-pane" id="ai-pane-{{ radio.name }}">
        <div id="ailogbox-{{ radio.name }}" class="logbox">{{ radio.ai_logs | join('\n') if radio.ai_logs else '' }}</div>
      </div>
      <div class="tab-pane" id="codewords-pane-{{ radio.name }}">
        <div id="codewords-{{ radio.name }}" class="logbox">{{ (radio.stats.previous_codewords if radio.stats and radio.stats.get('previous_codewords') else []) | join('\n') }}</div>
      </div>
    </div>
    <div>
      <h3>Radio Stats</h3>
      <textarea id="radio_stats_{{ radio.name }}">{{ radio.stats | tojson(indent = 2) }}</textarea><br>
    </div>
    <div>
      <h3>Performance Dashboard</h3>
      <div id="dashboard-{{ radio.name }}" class="dashboard-container">
        <div class="dashboard-grid">
          <!-- Performance Timeline Chart -->
          <div class="chart-container">
            <h4>Processing Times Timeline</h4>
            <canvas id="timeline-chart-{{ radio.name }}" width="400" height="200"></canvas>
          </div>

          <!-- Queue Health Gauge -->
          <!-- 
          <div class="chart-container">
            <h4>Transcription Queue Health</h4>
            <canvas id="queue-gauge-{{ radio.name }}" width="200" height="200"></canvas>
          </div>
          -->

          <!-- AI Activity Heatmap -->
          <div class="chart-container">
            <h4>AI Activity Heatmap</h4>
            <canvas id="ai-heatmap-{{ radio.name }}" width="400" height="200"></canvas>
          </div>

          <!-- Processing Rate Counter -->
          <div class="chart-container">
            <h4>Processing Rate</h4>
            <div id="rate-counter-{{ radio.name }}" class="rate-counter">
              <div class="rate-number">0</div>
              <div class="rate-label">events/min</div>
            </div>
          </div>

          <!-- Rolling Averages Display -->
          <div class="averages-container">
            <h4>Rolling Averages</h4>
            <div class="averages-grid">
              <div class="avg-card">
                <div class="avg-label">Transcribe</div>
                <div class="avg-value" id="avg-transcribe-{{ radio.name }}">0ms</div>
              </div>
              <div class="avg-card">
                <div class="avg-label">AI</div>
                <div class="avg-value" id="avg-ai-{{ radio.name }}">0ms</div>
              </div>
              <div class="avg-card">
                <div class="avg-label">Match</div>
                <div class="avg-value" id="avg-match-{{ radio.name }}">0ms</div>
              </div>
              <div class="avg-card">
                <div class="avg-label">Process</div>
                <div class="avg-value" id="avg-process-{{ radio.name }}">0ms</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <h3>Radio Config</h3>
      <textarea id="radio_conf_{{ radio.name }}">{{ radio.conf | tojson(indent = 2) }}</textarea><br>
      <button onclick="saveRadioConf('{{ radio.name }}')">Save Radio Config</button>
    </div>
    <div>
      <h3>Phrases</h3>
      <div id="phrases-list-{{ radio.name }}"></div>
      <button onclick="addPhrase('{{ radio.name }}')">Add Phrase</button>
      <button onclick="savePhrases('{{ radio.name }}')">Save Phrases</button>
    </div>
    <div>
      <h3>Control</h3>
      <button onclick="saveClip('{{ radio.name }}')">Save Clip</button>
      <button onclick="restartRadio('{{ radio.name }}')">Restart</button>
    </div>
  </div>
  {% endfor %}

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Set file browser link to same host, port 3002
    document.addEventListener("DOMContentLoaded", function () {
      var link = document.getElementById("filebrowser-link");
      var host = window.location.hostname;
      var protocol = window.location.protocol;
      link.href = protocol + '//' + host + ':3002';
    });

    const MATCH_OPTIONS = ["contains", "regex", "exact"];
    let radios = {{ radios | tojson}};

    // Dashboard data storage
    let dashboardData = {};

    // Initialize dashboard for each radio
    function initDashboard(radioName) {
      dashboardData[radioName] = {
        timelineData: {
          labels: [],
          transcribe: [],
          ai: [],
          match: [],
          process: []
        },
        queueHistory: [],
        aiHistory: [],
        rateHistory: [],
        lastEventCount: 0,
        lastTimestamp: Date.now()
      };

      // Initialize charts
      initTimelineChart(radioName);
      //initQueueGauge(radioName);
      initAIHeatmap(radioName);
    }

    // Performance Timeline Chart
    function initTimelineChart(radioName) {
      const ctx = document.getElementById(`timeline-chart-${radioName}`).getContext('2d');
      dashboardData[radioName].timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dashboardData[radioName].timelineData.labels,
          datasets: [
            {
              label: 'Transcribe',
              data: dashboardData[radioName].timelineData.transcribe,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.1
            },
            {
              label: 'AI',
              data: dashboardData[radioName].timelineData.ai,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.1
            },
            {
              label: 'Match',
              data: dashboardData[radioName].timelineData.match,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.1
            },
            {
              label: 'Process',
              data: dashboardData[radioName].timelineData.process,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Time (ms)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Time'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });
    }

    // Queue Health Gauge
    /*
    function initQueueGauge(radioName) {
      const ctx = document.getElementById(`queue-gauge-${radioName}`).getContext('2d');
      dashboardData[radioName].queueGauge = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [0, 100],
            backgroundColor: ['#10b981', '#e5e7eb'],
            borderWidth: 0,
            cutout: '70%'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
    */

    // AI Activity Heatmap
    function initAIHeatmap(radioName) {
      const ctx = document.getElementById(`ai-heatmap-${radioName}`).getContext('2d');
      dashboardData[radioName].aiHeatmap = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'AI Activity (ms)',
            data: [],
            backgroundColor: '#ef4444',
            borderColor: '#dc2626',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'AI Time (ms)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Time Windows'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // Update dashboard with new data
    function updateDashboard(radioName, stats) {
      const data = dashboardData[radioName];
      if (!data) return;

      const now = new Date();
      const timeLabel = now.toLocaleTimeString();

      // Update timeline chart
      const maxDataPoints = 20;
      data.timelineData.labels.push(timeLabel);
      data.timelineData.transcribe.push(stats.t_transcribe * 1000); // Convert to ms
      data.timelineData.ai.push(stats.t_ai * 1000);
      data.timelineData.match.push(stats.t_match * 1000);
      data.timelineData.process.push(stats.t_process * 1000);

      // Keep only recent data points
      if (data.timelineData.labels.length > maxDataPoints) {
        data.timelineData.labels.shift();
        data.timelineData.transcribe.shift();
        data.timelineData.ai.shift();
        data.timelineData.match.shift();
        data.timelineData.process.shift();
      }

      data.timelineChart.update();

      // Update queue gauge
      /*
      const queueUsage = stats.t_transcribe_in_len || 0;
      const queueMax = 4; // Based on queue maxsize
      const queuePercent = Math.min((queueUsage / queueMax) * 100, 100);

      data.queueGauge.data.datasets[0].data = [queuePercent, 100 - queuePercent];
      data.queueGauge.data.datasets[0].backgroundColor = [
        queuePercent > 80 ? '#ef4444' : queuePercent > 50 ? '#f59e0b' : '#10b981',
        '#e5e7eb'
      ];
      data.queueGauge.update();
      */

      // Update AI heatmap
      if (stats.t_ai > 0) {
        data.aiHeatmap.data.labels.push(timeLabel);
        data.aiHeatmap.data.datasets[0].data.push(stats.t_ai * 1000);

        if (data.aiHeatmap.data.labels.length > maxDataPoints) {
          data.aiHeatmap.data.labels.shift();
          data.aiHeatmap.data.datasets[0].data.shift();
        }

        data.aiHeatmap.update();
      }

      // Update processing rate counter
      const currentTime = Date.now();
      const timeDiff = (currentTime - data.lastTimestamp) / 1000 / 60; // minutes
      // only update every 30 seconds
      if (currentTime - data.lastTimestamp > 30000) {
        const eventDiff = stats.n_events - data.lastEventCount;
        const rate = timeDiff > 0 ? eventDiff / timeDiff : 0;

        escapedRadioName = radioName.replace(/\./g, "\\.");
        document.querySelector(`#rate-counter-${escapedRadioName} .rate-number`).textContent =
          Math.round(rate * 10) / 10;

        data.lastEventCount = stats.n_events;
        data.lastTimestamp = currentTime;
      }

      // Update rolling averages
      document.getElementById(`avg-transcribe-${radioName}`).textContent =
        Math.round(stats.avg_transcribe * 1000) + 'ms';
      document.getElementById(`avg-ai-${radioName}`).textContent =
        Math.round(stats.avg_ai * 1000) + 'ms';
      document.getElementById(`avg-match-${radioName}`).textContent =
        Math.round(stats.avg_match * 1000) + 'ms';
      document.getElementById(`avg-process-${radioName}`).textContent =
        Math.round(stats.avg_process * 1000) + 'ms';
    }

    // Fetch real-time stats for dashboard
    function fetchRealtimeStats(radioName) {
      fetch(`/radio/${radioName}/stats/realtime`)
        .then(response => response.json())
        .then(data => {
          if (data.stats) {
            updateDashboard(radioName, data.stats);
          }
        })
        .catch(error => console.error('Error fetching realtime stats:', error));
    }

    function saveConfig() {
      fetch('/update_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: document.getElementById("config").value
      }).then(() => alert("Config saved!"));
    }

    function saveRadioConf(name) {
      fetch(`/radio/${name}/update_conf`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: document.getElementById("radio_conf_" + name).value
      }).then(() => alert("Radio config saved!"));
    }

    function saveClip(name) {
      fetch(`/radio/${name}/save_clip`, { method: 'POST' })
        .then(res => res.json())
        .then(data => alert(data.message));
    }

    function restartRadio(name) {
      fetch(`/radio/${name}/restart`, { method: 'POST' })
        .then(res => res.json())
    }

    const TAB_TYPES = ["logs", "ai", "codewords"];
    const activeTabs = {};
    const tabPollers = {};

    function tabKey(name, tab) {
      return `${name}-${tab}`;
    }

    function clearTabPoller(name, tab) {
      const key = tabKey(name, tab);
      if (tabPollers[key]) {
        clearTimeout(tabPollers[key]);
        tabPollers[key] = null;
      }
    }

    function scheduleTabPoll(name, tab, fn) {
      if (activeTabs[name] !== tab) return;
      clearTabPoller(name, tab);
      tabPollers[tabKey(name, tab)] = setTimeout(fn, 2000);
    }

    function setActiveTab(name, tab) {
      activeTabs[name] = tab;
      TAB_TYPES.forEach(t => {
        const btn = document.getElementById(`tab-${t}-${name}`);
        const pane = document.getElementById(`${t}-pane-${name}`);
        if (btn) btn.classList.toggle("active", t === tab);
        if (pane) pane.classList.toggle("active", t === tab);
        clearTabPoller(name, t);
      });

      if (tab === "logs") {
        reloadLogs(name);
      } else if (tab === "ai") {
        reloadAILogs(name);
      } else {
        reloadCodewords(name);
      }
    }

    function reloadLogs(name) {
      if (activeTabs[name] !== "logs") return;
      fetch(`/radio/${name}/logs`)
        .then(res => res.json())
        .then(data => {
          const el = document.getElementById("logbox-" + name);
          el.innerText = data.logs.join("\n");
          el.scrollTop = el.scrollHeight;
        })
        .finally(() => {
          scheduleTabPoll(name, "logs", () => reloadLogs(name));
        });
    }

    function reloadAILogs(name) {
      if (activeTabs[name] !== "ai") return;
      fetch(`/radio/${name}/ai_logs`)
        .then(res => res.json())
        .then(data => {
          const el = document.getElementById("ailogbox-" + name);
          el.innerText = data.logs.join("\n");
          el.scrollTop = el.scrollHeight;
        })
        .finally(() => {
          scheduleTabPoll(name, "ai", () => reloadAILogs(name));
        });
    }

    function reloadCodewords(name) {
      if (activeTabs[name] !== "codewords") return;
      fetch(`/radio/${name}/codewords`)
        .then(res => res.json())
        .then(data => {
          const el = document.getElementById("codewords-" + name);
          const cw = data.codewords || [];
          el.innerText = cw.join("\n");
          el.scrollTop = el.scrollHeight;
        })
        .finally(() => {
          scheduleTabPoll(name, "codewords", () => reloadCodewords(name));
        });
    }

    function reloadStats(name) {
      fetch(`/radio/${name}/stats`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("radio_stats_" + name).value = JSON.stringify(data.stats, null, 2);
          document.getElementById("radio_stats_" + name).scrollTop = document.getElementById("radio_stats_" + name).scrollHeight;
          setTimeout(() => reloadStats(name), 2000);
        });
    }

    function renderPhrases(name) {
      let radio = radios.find(r => r.name === name);
      let phrases = radio.conf.PHRASES || [];
      const list = document.getElementById("phrases-list-" + name);
      list.innerHTML = "";
      phrases.forEach((ph, idx) => {
        const div = document.createElement("div");
        div.style.marginBottom = "5px";
        div.innerHTML = `
      <input type="text" value="${ph.text}" style="width:60%" onchange="updatePhraseText('${name}',${idx}, this.value)">
        <select onchange="updatePhraseMatch('${name}',${idx}, this.value)">
          ${MATCH_OPTIONS.map(opt => `<option value="${opt}"${ph.mode === opt ? " selected" : ""}>${opt}</option>`).join("")}
        </select>
        <button onclick="deletePhrase('${name}',${idx})">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    function updatePhraseText(name, idx, val) {
      let radio = radios.find(r => r.name === name);
      radio.conf.PHRASES[idx].text = val;
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function updatePhraseMatch(name, idx, val) {
      let radio = radios.find(r => r.name === name);
      radio.conf.PHRASES[idx].mode = val;
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function deletePhrase(name, idx) {
      let radio = radios.find(r => r.name === name);
      radio.conf.PHRASES.splice(idx, 1);
      renderPhrases(name);
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function addPhrase(name) {
      let radio = radios.find(r => r.name === name);
      if (!radio.conf.PHRASES) radio.conf.PHRASES = [];
      radio.conf.PHRASES.push({ text: "", mode: "contains" });
      renderPhrases(name);
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function savePhrases(name) {
      let radio = radios.find(r => r.name === name);
      fetch(`/radio/${name}/update_conf`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(radio.conf)
      }).then(() => alert("Phrases saved!"));
    }

    document.addEventListener("DOMContentLoaded", function () {
      radios.forEach(radio => {
        renderPhrases(radio.name);
        setActiveTab(radio.name, "logs");
        reloadStats(radio.name);
        document.getElementById("radio_conf_" + radio.name).value = JSON.stringify(radio.conf, null, 2);

        // Initialize dashboard
        initDashboard(radio.name);

        // Start real-time dashboard updates
        setInterval(() => {
          fetchRealtimeStats(radio.name);
        }, 2000); // Update every 2 seconds
      });
    });

    /*
    window.onload = function () {
      radios.forEach(radio => {
        renderPhrases(radio.name);
        reloadLogs(radio.name);
        document.getElementById("radio_conf_" + radio.name).value = JSON.stringify(radio.conf, null, 2);
      });
    }
    */
  </script>
</body>

</html>
