<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Audio Monitor</title>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
    }

    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
    }

    .logbox {
      width: 100%;
      height: 250px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      background: #000;
      color: #0f0;
      padding: 5px;
      white-space: pre-wrap;
    }

    .section {
      margin-bottom: 30px;
    }

    button {
      margin-top: 5px;
    }

    audio {
      display: block;
      margin-top: 5px;
    }

    .radio-section {
      border: 2px solid #ccc;
      padding: 10px;
      margin-bottom: 30px;
    }
  </style>
</head>

<body>

  <h1>Audio Monitor</h1>
  <div style="margin-bottom: 20px;">
    <a href="javascript:void(0)" id="filebrowser-link" target="_blank">Open File Browser</a>
  </div>

  <div class="section">
    <h2>Main Config</h2>
    <textarea id="config">{{ config | tojson(indent = 2)}}</textarea><br>
    <button onclick="saveConfig()">Save Config</button>
  </div>

  {% for radio in radios %}
  <div class="radio-section">
    <h2>{{ radio.name }}</h2>
    <div>
      <h3>Live Stream</h3>
      <audio controls>
        <source src="{{ radio.stream_url }}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    </div>
    <div>
      <h3>Live Logs</h3>
      <div id="logbox-{{ radio.name }}" class="logbox">{{ radio.logs | join('\n') }}</div>
    </div>
    <div>
      <h3>Radio Stats</h3>
      <textarea id="radio_stats_{{ radio.name }}">{{ radio.stats | tojson(indent = 2) }}</textarea><br>
    </div>
    <div>
      <h3>Radio Config</h3>
      <textarea id="radio_conf_{{ radio.name }}">{{ radio.conf | tojson(indent = 2) }}</textarea><br>
      <button onclick="saveRadioConf('{{ radio.name }}')">Save Radio Config</button>
    </div>
    <div>
      <h3>Phrases</h3>
      <div id="phrases-list-{{ radio.name }}"></div>
      <button onclick="addPhrase('{{ radio.name }}')">Add Phrase</button>
      <button onclick="savePhrases('{{ radio.name }}')">Save Phrases</button>
    </div>
    <div>
      <h3>Control</h3>
      <button onclick="saveClip('{{ radio.name }}')">Save Clip</button>
      <button onclick="restartRadio('{{ radio.name }}')">Restart</button>
    </div>
  </div>
  {% endfor %}

  <script>
    // Set file browser link to same host, port 3002
    document.addEventListener("DOMContentLoaded", function () {
      var link = document.getElementById("filebrowser-link");
      var host = window.location.hostname;
      var protocol = window.location.protocol;
      link.href = protocol + '//' + host + ':3002';
    });

    const MATCH_OPTIONS = ["contains", "regex", "exact"];
    let radios = {{ radios | tojson}};

    function saveConfig() {
      fetch('/update_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: document.getElementById("config").value
      }).then(() => alert("Config saved!"));
    }

    function saveRadioConf(name) {
      fetch(`/radio/${name}/update_conf`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: document.getElementById("radio_conf_" + name).value
      }).then(() => alert("Radio config saved!"));
    }

    function saveClip(name) {
      fetch(`/radio/${name}/save_clip`, { method: 'POST' })
        .then(res => res.json())
        .then(data => alert(data.message));
    }

    function restartRadio(name) {
      fetch(`/radio/${name}/restart`, { method: 'POST' })
        .then(res => res.json())
    }

    function reloadLogs(name) {
      fetch(`/radio/${name}/logs`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("logbox-" + name).innerText = data.logs.join("\n");
          document.getElementById("logbox-" + name).scrollTop = document.getElementById("logbox-" + name).scrollHeight;
          setTimeout(() => reloadLogs(name), 2000);
        });
    }

    function reloadStats(name) {
      fetch(`/radio/${name}/stats`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("radio_stats_" + name).value = JSON.stringify(data.stats, null, 2);
          document.getElementById("radio_stats_" + name).scrollTop = document.getElementById("radio_stats_" + name).scrollHeight;
          setTimeout(() => reloadStats(name), 2000);
        });
    }

    function renderPhrases(name) {
      let radio = radios.find(r => r.name === name);
      let phrases = radio.conf.PHRASES || [];
      const list = document.getElementById("phrases-list-" + name);
      list.innerHTML = "";
      phrases.forEach((ph, idx) => {
        const div = document.createElement("div");
        div.style.marginBottom = "5px";
        div.innerHTML = `
      <input type="text" value="${ph.text}" style="width:60%" onchange="updatePhraseText('${name}',${idx}, this.value)">
        <select onchange="updatePhraseMatch('${name}',${idx}, this.value)">
          ${MATCH_OPTIONS.map(opt => `<option value="${opt}"${ph.mode === opt ? " selected" : ""}>${opt}</option>`).join("")}
        </select>
        <button onclick="deletePhrase('${name}',${idx})">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    function updatePhraseText(name, idx, val) {
      let radio = radios.find(r => r.name === name);
      radio.conf.PHRASES[idx].text = val;
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function updatePhraseMatch(name, idx, val) {
      let radio = radios.find(r => r.name === name);
      radio.conf.PHRASES[idx].mode = val;
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function deletePhrase(name, idx) {
      let radio = radios.find(r => r.name === name);
      radio.conf.PHRASES.splice(idx, 1);
      renderPhrases(name);
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function addPhrase(name) {
      let radio = radios.find(r => r.name === name);
      if (!radio.conf.PHRASES) radio.conf.PHRASES = [];
      radio.conf.PHRASES.push({ text: "", mode: "contains" });
      renderPhrases(name);
      document.getElementById("radio_conf_" + name).value = JSON.stringify(radio.conf, null, 2);
    }
    function savePhrases(name) {
      let radio = radios.find(r => r.name === name);
      fetch(`/radio/${name}/update_conf`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(radio.conf)
      }).then(() => alert("Phrases saved!"));
    }

    document.addEventListener("DOMContentLoaded", function () {
      radios.forEach(radio => {
        renderPhrases(radio.name);
        reloadLogs(radio.name);
        reloadStats(radio.name);
        document.getElementById("radio_conf_" + radio.name).value = JSON.stringify(radio.conf, null, 2);
      });
    });

    /*
    window.onload = function () {
      radios.forEach(radio => {
        renderPhrases(radio.name);
        reloadLogs(radio.name);
        document.getElementById("radio_conf_" + radio.name).value = JSON.stringify(radio.conf, null, 2);
      });
    }
    */
  </script>
</body>

</html>